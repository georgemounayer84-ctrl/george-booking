<script>
  const API_BASE = "https://jnxmxhnzxfwgiwxziwbp.functions.supabase.co"; 
  const RESTAURANT_ID = "11111111-1111-1111-1111-111111111111"; // din restaurang UUID

  document.getElementById('gb-check').onclick = async () => {
    const date = document.getElementById('gb-date').value;
    const party = document.getElementById('gb-party').value;
    if(!date) return alert('Välj datum');

    // Anropar /bookings och filtrerar på restaurant_id + datum (enklare klient-side filter)
    const res = await fetch(`${API_BASE}/bookings?restaurant_id=${RESTAURANT_ID}`);
    const j = await res.json();
    const slotsDiv = document.getElementById('gb-slots');
    slotsDiv.innerHTML = '';

    const bookings = j.data || [];
    // Här skapar vi demo-slots baserat på tider (förenklat): visa timmar 18:00–21:00 och markera ledigt om ingen bokning på samma tid
    const baseDate = new Date(date);
    const times = [18,19,20];
    times.forEach(hour => {
      const start = new Date(Date.UTC(baseDate.getUTCFullYear(), baseDate.getUTCMonth(), baseDate.getUTCDate(), hour, 0, 0)).toISOString();
      const occupied = bookings.some(b => b.reserved_at && b.reserved_at.startsWith(start.slice(0,13)));
      const btn = document.createElement('button');
      const t = new Date(start).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
      btn.innerText = occupied ? `${t} — fullt` : `${t} — boka`;
      btn.disabled = occupied;
      btn.onclick = () => {
        document.getElementById('gb-form').style.display='block';
        document.getElementById('gb-form').dataset.start = start;
      };
      slotsDiv.appendChild(btn);
    });
  };

  document.getElementById('gb-book').onclick = async () => {
    const name = document.getElementById('gb-name').value;
    const email = document.getElementById('gb-email').value;
    const phone = document.getElementById('gb-phone').value;
    const party = parseInt(document.getElementById('gb-party').value,10);
    const start = document.getElementById('gb-form').dataset.start;

    const payload = {
      restaurant_id: RESTAURANT_ID,
      guest_name: name,
      guest_email: email,
      guest_phone: phone,
      covers: party,
      reserved_at: start,
      source: 'widget'
    };

    const resp = await fetch(`${API_BASE}/bookings`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const j = await resp.json();
    if(resp.status===201){ 
      document.getElementById('gb-msg').innerText = 'Bokning bekräftad!'; 
      document.getElementById('gb-form').style.display='none'; 
    } else { 
      document.getElementById('gb-msg').innerText = 'Fel: '+(j.error||JSON.stringify(j)); 
    }
  };
</script>
