<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>George Booking Widget</title>
  <style>
    /* Enkel styling så det syns i Pages */
    #gb-widget { font-family: Arial, Helvetica, sans-serif; max-width:420px; margin:20px; }
    #gb-slots button{ margin:6px 6px 0 0; padding:6px 10px; }
    #gb-form input{ display:block; margin:6px 0; padding:6px; width:100%; box-sizing:border-box; }
  </style>
</head>
<body>
  <div id="gb-widget">
    <h3>Boka bord</h3>
    <label>Datum: <input type="date" id="gb-date" /></label>
    <label>Antal:
      <select id="gb-party">
        <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option>
      </select>
    </label>
    <button id="gb-check">Sök tider</button>
    <div id="gb-slots"></div>
    <div id="gb-form" style="display:none">
      <input id="gb-name" placeholder="Namn" />
      <input id="gb-email" placeholder="E-post" />
      <input id="gb-phone" placeholder="Telefon" />
      <button id="gb-book">Boka</button>
    </div>
    <div id="gb-msg"></div>
  </div>

  <script>
    // kör först när DOM är klar
    window.addEventListener('DOMContentLoaded', () => {
      const API_BASE = "https://jnxmxhnzxfwgiwxziwbp.functions.supabase.co";
      const RESTAURANT_ID = "11111111-1111-1111-1111-111111111111";

      const gbCheck = document.getElementById('gb-check');
      const gbBook = document.getElementById('gb-book');

      gbCheck.onclick = async () => {
        const date = document.getElementById('gb-date').value;
        const party = document.getElementById('gb-party').value;
        if(!date) return alert('Välj datum');
        const res = await fetch(`${API_BASE}/bookings?restaurant_id=${RESTAURANT_ID}`);
        const data = await res.json();
        const slotsDiv = document.getElementById('gb-slots');
        slotsDiv.innerHTML = '';
        const bookings = data.data || [];
        const baseDate = new Date(date);
        const times = [18,19,20];
        times.forEach(hour => {
          const start = new Date(Date.UTC(baseDate.getUTCFullYear(), baseDate.getUTCMonth(), baseDate.getUTCDate(), hour,0,0)).toISOString();
          const occupied = bookings.some(b => b.reserved_at && b.reserved_at.startsWith(start.slice(0,13)));
          const btn = document.createElement('button');
          const t = new Date(start).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
          btn.innerText = occupied ? `${t} — fullt` : `${t} — boka`;
          btn.disabled = occupied;
          btn.onclick = () => {
            document.getElementById('gb-form').style.display='block';
            document.getElementById('gb-form').dataset.start = start;
          };
          slotsDiv.appendChild(btn);
        });
      };

      gbBook.onclick = async () => {
        const name = document.getElementById('gb-name').value;
        const email = document.getElementById('gb-email').value;
        const phone = document.getElementById('gb-phone').value;
        const party = parseInt(document.getElementById('gb-party').value,10);
        const start = document.getElementById('gb-form').dataset.start;
        const payload = {
          restaurant_id: RESTAURANT_ID,
          guest_name: name,
          guest_email: email,
          guest_phone: phone,
          covers: party,
          reserved_at: start,
          source: 'widget'
        };
        const resp = await fetch(`${API_BASE}/bookings`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const j = await resp.json();
        if(resp.status===201){
          document.getElementById('gb-msg').innerText = 'Bokning bekräftad!';
          document.getElementById('gb-form').style.display='none';
        } else {
          document.getElementById('gb-msg').innerText = 'Fel: '+(j.error||JSON.stringify(j));
        }
      };
    });
  </script>
</body>
</html>
