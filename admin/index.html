<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>George Booking — Admin</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:18px}
    table{border-collapse:collapse;width:100%;max-width:1100px}
    th,td{border:1px solid #ddd;padding:8px;text-align:left}
    th{background:#f4f4f4}
    button{padding:6px 10px;margin:0 4px}
    .muted{color:#666;font-size:0.9em}
  </style>
</head>
<body>
  <h1>George Booking — Admin</h1>
  <p class="muted">Visar bokningar för restaurang (redigera RESTAURANT_ID nedan vid behov).</p>
  <div>
    <label>Restaurant UUID: <input id="restaurant" value="11111111-1111-1111-1111-111111111111" style="width:420px"></label>
    <button id="refresh">Ladda</button>
  </div>
  <div id="msg" style="margin-top:10px"></div>
  <table id="tbl" style="margin-top:12px">
    <thead><tr><th>Reservation</th><th>Guest</th><th>Covers</th><th>Reserved at (UTC)</th><th>Status</th><th>Actions</th></tr></thead>
    <tbody></tbody>
  </table>

  <script>
    const API_BASE = "https://jnxmxhnzxfwgiwxziwbp.functions.supabase.co";
    const refreshBtn = document.getElementById('refresh');
    const tblBody = document.querySelector('#tbl tbody');
    const msg = document.getElementById('msg');

    async function load() {
      const rid = document.getElementById('restaurant').value.trim();
      if(!rid){ alert('Sätt restaurant-id'); return; }
      msg.innerText = 'Laddar...';
      try{
        const res = await fetch(`${API_BASE}/bookings?restaurant_id=${rid}`);
        const j = await res.json();
        const bookings = j.data || [];
        tblBody.innerHTML = '';
        if(bookings.length===0){
          tblBody.innerHTML = '<tr><td colspan="6">Inga bokningar</td></tr>';
        } else {
          bookings.forEach(b => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td style="min-width:220px">${b.id}<br/><span class="muted">${b.sitting_id || ''}</span></td>
              <td>${b.guest_name}<br/><span class="muted">${b.guest_email||''} ${b.guest_phone||''}</span></td>
              <td>${b.covers}</td>
              <td>${b.reserved_at}</td>
              <td>${b.status}</td>
              <td>
                <button data-id="${b.id}" class="cancel">Markera avbokad</button>
                <button data-id="${b.id}" class="delete">Radera</button>
              </td>`;
            tblBody.appendChild(tr);
          });
        }
        msg.innerText = '';
      }catch(e){
        msg.innerText = 'Fel vid hämtning: '+e.message;
      }
    }

    // actions: send to Edge Function (handled later)
    async function postAction(path, body){
      const res = await fetch(`${API_BASE}${path}`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      return res;
    }

    // event handlers
    refreshBtn.onclick = load;

    tblBody.addEventListener('click', async (ev) => {
      const btn = ev.target.closest('button');
      if(!btn) return;
      const id = btn.dataset.id;
      if(btn.classList.contains('cancel')){
        if(!confirm('Markera bokningen som avbokad?')) return;
        // Vi använder en action som vi implementerar senare i Edge Function: /bookings?action=cancel
        const resp = await postAction('/bookings?action=cancel', { id });
        if(resp.status === 200 || resp.status === 204){
          alert('Markerad som avbokad.');
          load();
        } else {
          const j = await resp.json().catch(()=>({error:'okänt'}));
          alert('Fel: '+(j.error||JSON.stringify(j)));
        }
      } else if(btn.classList.contains('delete')){
        if(!confirm('Radera bokningen permanent?')) return;
        // action delete (implementeras senare): /bookings?action=delete
        const resp = await postAction('/bookings?action=delete', { id });
        if(resp.status === 200 || resp.status === 204){
          alert('Raderad.');
          load();
        } else {
          const j = await resp.json().catch(()=>({error:'okänt'}));
          alert('Fel: '+(j.error||JSON.stringify(j)));
        }
      }
    });

    // auto-load on open
    window.addEventListener('DOMContentLoaded', load);
  </script>
</body>
</html>
